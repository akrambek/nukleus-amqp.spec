#
# Copyright 2016-2020 The Reaktivity Project
#
# The Reaktivity Project licenses this file to you under the Apache License,
# version 2.0 (the "License"); you may not use this file except in compliance
# with the License. You may obtain a copy of the License at:
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.
#

property serverTransport "nukleus://streams/target#0"
property message520 ${amqp:randomBytes(520)}
property message212 ${amqp:randomBytes(212)}
property message80 ${amqp:randomBytes(80)}

accept ${serverTransport}
  option nukleus:window 8192
  option nukleus:transmission "duplex"

accepted
connected

# header exchange
read "AMQP" [0x00 0x01 0x00 0x00]
write "AMQP" [0x00 0x01 0x00 0x00]

# open frame exchange
read [0x00 0x00 0x00 0x23]                                      # length = 35
     [0x02]                                                     # doff = 2
     [0x00]                                                     # type = AMQP (0)
     [0x00 0x00]                                                # channel = 0
     [0x00 0x53 0x10]                                           # performative = open (16)
     [0xc0 0x16]                                                # list type (LIST1), length = 22
     [0x03]                                                     # field count = 3
     [0xa1 0x06] "client"                                       # container-id = "client"
     [0xa1 0x06] "server"                                       # hostname = "server"
     [0x70 0x00 0x00 0x02 0x26]                                 # max frame size = 550

write [0x00 0x00 0x00 0x1c]                                     # length = 28
      [0x02]                                                    # doff = 2
      [0x00]                                                    # type = AMQP (0)
      [0x00 0x00]                                               # channel = 0
      [0x00 0x53 0x10]                                          # performative = open (16)
      [0xc0 0x0f]                                               # list type (LIST1), length = 15
      [0x03]                                                    # field count = 3
      [0xa1 0x06] "server"                                      # container-id = "server"
      [0x40]                                                    # hostname = null
      [0x70 0x00 0x02 0x00 0x00]                                # max frame size = 131072

# begin frame exchange
read [0x00 0x00 0x00 0x18]                                      # length = 24
     [0x02]                                                     # doff = 2
     [0x00]                                                     # type = AMQP (0)
     [0x00 0x01]                                                # channel = 1
     [0x00 0x53 0x11]                                           # performative = begin (17)
     [0xc0 0x0b]                                                # list type (list8), length = 11
     [0x04]                                                     # field count = 4
     [0x40]                                                     # remote-channel = null
     [0x52 0x01]                                                # next-outgoing-id = 1
     [0x52 0x01]                                                # incoming-window = 1
     [0x70 0x7f 0xff 0xff 0xff]                                 # outgoing-window = 2147483647

write [0x00 0x00 0x00 0x1d]                                     # length = 29
      [0x02]                                                    # doff = 2
      [0x00]                                                    # type = AMQP (0)
      [0x00 0x01]                                               # channel = 1
      [0x00 0x53 0x11]                                          # performative = begin (17)
      [0xc0 0x10]                                               # list type (list8), length = 16
      [0x04]                                                    # field count = 4
      [0x60 0x00 0x01]                                          # remote-channel = 1
      [0x52 0x01]                                               # next-outgoing-id = 1
      [0x70 0x00 0x01 0x00 0x00]                                # incoming-window = 65536
      [0x70 0x7f 0xff 0xff 0xff]                                # outgoing-window = 2147483647

# attach frame exchange for link1
read [0x00 0x00 0x00 0x2a]                                      # length = 42
     [0x02]                                                     # doff = 2
     [0x00]                                                     # type = AMQP (0)
     [0x00 0x01]                                                # channel = 1
     [0x00 0x53 0x12]                                           # performative = attach (18)
     [0xc0 0x1d]                                                # list type (list8), length = 29
     [0x06]                                                     # field count = 6
     [0xa1 0x05] "link1"                                        # name = "link1"
     [0x43]                                                     # handle = 0
     [0x41]                                                     # role = receiver
     [0x50 0x01]                                                # snd-settle-mode = settled
     [0x50 0x00]                                                # rcv-settle-mode = first
     [0x00 0x53 0x28]                                           # source
     [0xc0 0x0a]                                                # list type (list8), length = 10
     [0x01]                                                     # field count = 1
     [0xa1 0x07] "clients"                                      # address = "clients"

write [0x00 0x00 0x00 0x31]                                     # length = 49
      [0x02]                                                    # doff = 2
      [0x00]                                                    # type = AMQP (0)
      [0x00 0x01]                                               # channel = 1
      [0x00 0x53 0x12]                                          # performative = attach (18)
      [0xc0 0x24]                                               # list type (list8), length = 36
      [0x0a]                                                    # field count = 10
      [0xa1 0x05] "link1"                                       # name = "link1"
      [0x43]                                                    # handle = 0
      [0x42]                                                    # role = sender
      [0x50 0x01]                                               # snd-settle-mode = settled
      [0x50 0x00]                                               # rcv-settle-mode = first
      [0x00 0x53 0x28]                                          # source
      [0xc0 0x0a]                                               # list type (list8), length = 10
      [0x01]                                                    # field count = 1
      [0xa1 0x07] "clients"                                     # address = "clients"
      [0x00 0x53 0x29 0x45]                                     # target = empty list
      [0x40]                                                    # unsettled = null
      [0x40]                                                    # incomplete-unsettled = null (default = false)
      [0x43]                                                    # initial-delivery-count = 0

# flow frame for link1
read [0x00 0x00 0x00 0x1d]                                      # length = 29
     [0x02]                                                     # doff = 2
     [0x00]                                                     # type = AMQP (0)
     [0x00 0x01]                                                # channel = 1
     [0x00 0x53 0x13]                                           # performative = flow (19)
     [0xc0 0x10]                                                # list type (list8), length = 16
     [0x07]                                                     # field count = 7
     [0x52 0x01]                                                # next-incoming-id = 1
     [0x52 0x01]                                                # incoming-window = 1
     [0x52 0x01]                                                # next-outgoing-id = 1
     [0x70 0x7f 0xff 0xff 0xff]                                 # outgoing-window = 2147483647
     [0x43]                                                     # handle = 0
     [0x43]                                                     # delivery-count = 0
     [0x52 0x01]                                                # link-credit = 1

# transfer frame for link1 with message 1/2
write [0x00 0x00 0x02 0x26]                                       # length = 550
     [0x02]                                                      # doff = 2
     [0x00]                                                      # type = AMQP (0)
     [0x00 0x01]                                                 # channel = 1
     [0x00 0x53 0x14]                                            # performative = transfer (20)
     [0xc0 0x09 0x06]                                            # list type (list8), length = 9, field count = 6
     [0x43]                                                      # handle = 0
     [0x43]                                                      # delivery-id = 0
     [0xa0 0x01 0x30]                                            # delivery-tag = "0"
     [0x43]                                                      # message-format = 0
     [0x41]                                                      # settled = true
     [0x41]                                                      # more = true

     [0x00 0x53 0x72]                                            # message-annotations header
     [0xc1 0x4c 0x0a]                                            # map8, length = 76, field count = 10
     [0xa3 0x0b] "annotation1"                                   # map key = annotation1
     [0x51 0x31]                                                 # map value = 49 (byte)
     [0xa3 0x0b] "annotation2"                                   # map key = annotation2
     [0x51 0x32]                                                 # map value = 50 (byte)
     [0xa3 0x0b] "annotation3"                                   # map key = annotation3
     [0x51 0x33]                                                 # map value = 51 (byte)
     [0xa3 0x0b] "annotation4"                                   # map key = annotation4
     [0x51 0x34]                                                 # map value = 52 (byte)
     [0xa3 0x0b] "annotation5"                                   # map key = annotation5
     [0x51 0x35]                                                 # map value = 53 (byte)

     [0x00 0x53 0x73]                                            # properties header
     [0xc0 0x8f 0x0d]                                            # list8, length = 143, field count = 13
     [0xa1 0x08] "message1"                                      # message-id = "message1"
     [0xa0 0x05] "user1"                                         # user-id = "user1"
     [0xa1 0x07] "clients"                                       # to = "clients"
     [0xa1 0x08] "subject1"                                      # subject = "subject1"
     [0xa1 0x09] "localhost"                                     # reply-to = "localhost"
     [0xa1 0x0e] "correlationId1"                                # correlation-id = "correlationId1"
     [0xa3 0x0c] "content_type"                                  # content-type = "content_type"
     [0xa3 0x10] "content_encoding"                              # content-encoding = "content_encoding"
     [0x83 0x00 0x00 0x00 0x00 0x00 0x00 0x30 0x39]              # absolute-expiry-time = 12345
     [0x83 0x00 0x00 0x00 0x00 0x00 0x00 0x30 0x39]              # creation-time = 12345
     [0xa1 0x09] "group_id1"                                     # group-id = "group_id1"
     [0x52 0x01]                                                 # group-sequence = 1
     [0xa1 0x0e] "reply_group_id"                                # reply-to-group-id = "reply_group_id"

     [0x00 0x53 0x74]                                            # application-properties header
     [0xc1 0x49 0x06]                                            # map8, length = 73, field count = 6
     [0xa1 0x0b] "application"                                   # map key = "application"
     [0xa1 0x09] "property1"                                     # map value = "property1"
     [0xa1 0x0b] "application"                                   # map key = "application"
     [0xa1 0x09] "property2"                                     # map value = "property2"
     [0xa1 0x0b] "application"                                   # map key = "application"
     [0xa1 0x09] "property3"                                     # map value = "property3"
write [0x00 0x53 0x77 0xb0 0x00 0x00 0x00 0xfa] ${message212}    # payload = 212 random bytes

# attach frame exchange for link2
read [0x00 0x00 0x00 0x2b]                                      # length = 43
     [0x02]                                                     # doff = 2
     [0x00]                                                     # type = AMQP (0)
     [0x00 0x01]                                                # channel = 1
     [0x00 0x53 0x12]                                           # performative = attach (18)
     [0xc0 0x1e]                                                # list type (list8), length = 30
     [0x06]                                                     # field count = 6
     [0xa1 0x05] "link2"                                        # name = "link2"
     [0x52 0x01]                                                # handle = 1
     [0x41]                                                     # role = receiver
     [0x50 0x01]                                                # snd-settle-mode = settled
     [0x50 0x00]                                                # rcv-settle-mode = first
     [0x00 0x53 0x28]                                           # source
     [0xc0 0x0a]                                                # list type (list8), length = 10
     [0x01]                                                     # field count = 1
     [0xa1 0x07] "clients"                                      # address = "clients"

write [0x00 0x00 0x00 0x32]                                     # length = 50
      [0x02]                                                    # doff = 2
      [0x00]                                                    # type = AMQP (0)
      [0x00 0x01]                                               # channel = 1
      [0x00 0x53 0x12]                                          # performative = attach (18)
      [0xc0 0x25]                                               # list type (list8), length = 37
      [0x0a]                                                    # field count = 10
      [0xa1 0x05] "link2"                                       # name = "link2"
      [0x52 0x01]                                               # handle = 1
      [0x42]                                                    # role = sender
      [0x50 0x01]                                               # snd-settle-mode = settled
      [0x50 0x00]                                               # rcv-settle-mode = first
      [0x00 0x53 0x28]                                          # source
      [0xc0 0x0a]                                               # list type (list8), length = 10
      [0x01]                                                    # field count = 1
      [0xa1 0x07] "clients"                                     # address = "clients"
      [0x00 0x53 0x29 0x45]                                     # target = empty list
      [0x40]                                                    # unsettled = null
      [0x40]                                                    # incomplete-unsettled = null (default = false)
      [0x43]                                                    # initial-delivery-count = 0

# flow frame for link2
read [0x00 0x00 0x00 0x1e]                                      # length = 30
     [0x02]                                                     # doff = 2
     [0x00]                                                     # type = AMQP (0)
     [0x00 0x01]                                                # channel = 1
     [0x00 0x53 0x13]                                           # performative = flow (19)
     [0xc0 0x11]                                                # list type (list8), length = 17
     [0x07]                                                     # field count = 7
     [0x52 0x02]                                                # next-incoming-id = 2
     [0x52 0x01]                                                # incoming-window = 1
     [0x52 0x01]                                                # next-outgoing-id = 1
     [0x70 0x7f 0xff 0xff 0xff]                                 # outgoing-window = 2147483647
     [0x52 0x01]                                                # handle = 1
     [0x43]                                                     # delivery-count = 0
     [0x52 0x01]                                                # link-credit = 1

# transfer frame for link2 with message 1/2
write [0x00 0x00 0x02 0x26]                                     # length = 550
      [0x02]                                                    # doff = 2
      [0x00]                                                    # type = AMQP (0)
      [0x00 0x01]                                               # channel = 1
      [0x00 0x53 0x14]                                          # performative = transfer (20)
      [0xc0 0x0a 0x06]                                          # list type (list8), length = 10, field count = 6
      [0x52 0x01]                                               # handle = 1
      [0x43]                                                    # delivery-id = 0
      [0xa0 0x01 0x30]                                          # delivery-tag = "0"
      [0x43]                                                    # message-format = 0
      [0x41]                                                    # settled = true
      [0x41]                                                    # more = true
write [0x00 0x53 0x77 0xb0 0x00 0x00 0x02 0x58] ${message520}   # payload = 520 random bytes

# flow frame for link1
read [0x00 0x00 0x00 0x1e]                                      # length = 30
     [0x02]                                                     # doff = 2
     [0x00]                                                     # type = AMQP (0)
     [0x00 0x01]                                                # channel = 1
     [0x00 0x53 0x13]                                           # performative = flow (19)
     [0xc0 0x11]                                                # list type (list8), length = 17
     [0x07]                                                     # field count = 7
     [0x52 0x03]                                                # next-incoming-id = 3
     [0x52 0x01]                                                # incoming-window = 1
     [0x52 0x01]                                                # next-outgoing-id = 1
     [0x70 0x7f 0xff 0xff 0xff]                                 # outgoing-window = 2147483647
     [0x43]                                                     # handle = 0
     [0x52 0x01]                                                # delivery-count = 1
     [0x52 0x01]                                                # link-credit = 1

# transfer frame for link1 with message 2/2
write [0x00 0x00 0x00 0x5f]                                     # length = 95
      [0x02]                                                    # doff = 2
      [0x00]                                                    # type = AMQP (0)
      [0x00 0x01]                                               # channel = 1
      [0x00 0x53 0x14]                                          # performative = transfer (20)
      [0xc0 0x02 0x01]                                          # list type (list8), length = 2, field count = 1
      [0x43]                                                    # handle = 0
write ${message80}                                              # payload = 80 random bytes

# flow frame for link2
read [0x00 0x00 0x00 0x1f]                                      # length = 31
     [0x02]                                                     # doff = 2
     [0x00]                                                     # type = AMQP (0)
     [0x00 0x01]                                                # channel = 1
     [0x00 0x53 0x13]                                           # performative = flow (19)
     [0xc0 0x12 0x07]                                           # list type (list8), length = 18, field count = 7
     [0x52 0x04]                                                # next-incoming-id = 4
     [0x52 0x01]                                                # incoming-window = 1
     [0x52 0x01]                                                # next-outgoing-id = 1
     [0x70 0x7f 0xff 0xff 0xff]                                 # outgoing-window = 2147483647
     [0x52 0x01]                                                # handle = 1
     [0x52 0x01]                                                # delivery-count = 1
     [0x52 0x01]                                                # link-credit = 1

# transfer frame for link2 with message 2/2
write [0x00 0x00 0x00 0x5f]                                     # length = 95
      [0x02]                                                    # doff = 2
      [0x00]                                                    # type = AMQP (0)
      [0x00 0x01]                                               # channel = 1
      [0x00 0x53 0x14]                                          # performative = transfer (20)
      [0xc0 0x02 0x01]                                          # list type (list8), length = 2, field count = 1
      [0x52 0x01]                                               # handle = 1
write ${message80}                                              # payload = 80 random bytes
